# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Diala is a voice agent application that enables real-time voice conversations through web browsers and phone calls. It features a multi-step onboarding flow with voice cloning capabilities and a distinctive Neobrutalist/Memphis design system.

## Development Best Practices

- When working with Python projects, always activate the virtual environment before running commands using `source venv/bin/activate` (or the appropriate activation script for your system)

## Common Development Commands

### Frontend (Next.js + Convex)
```bash
cd frontend
npm install          # Install dependencies
npm run dev:all      # Start both Convex dev server and Next.js dev server
npm run dev          # Start Next.js dev server only (http://localhost:3000)
npm run convex:dev   # Start Convex dev server only
npm run build        # Build for production
npm run start        # Start production server
npm run lint         # Run ESLint
npm run convex:deploy # Deploy Convex functions
```

### Backend (FastAPI)
```bash
cd backend
pip install -r requirements.txt    # Install Python dependencies
python -m src.main                 # Start the backend server
```

### Required Services
```bash
redis-server    # Start Redis (required for session management)
```

## Architecture Overview

### Tech Stack
- **Backend**: FastAPI (Python) with WebSocket support
- **Frontend**: Next.js 14, React 18, TypeScript, Tailwind CSS
- **Database/Backend-as-a-Service**: Convex for real-time data and serverless functions
- **Real-time Communication**: WebSocket protocol for bidirectional audio/text
- **Audio Processing**: GStreamer pipeline, FFmpeg, Whisper transcription
- **State Management**: Redis for caching and sessions, Convex for persistent data

### External Service Integrations
- **Telnyx**: PSTN telephony integration
- **Deepgram**: Speech-to-text (STT)
- **OpenAI**: Language model for conversations
- **TTS Providers**: ElevenLabs (commercial), Chatterbox (open-source), Dia, Orpheus
- **Content APIs**: YouTube, TikTok, Twitch for transcript and content fetching
- **Hunter API**: Lead generation and business intelligence
- **Jina AI**: Embeddings and RAG (Retrieval-Augmented Generation)

### Key Architectural Patterns

1. **Hybrid Architecture**: FastAPI backend + Convex serverless functions for different concerns
2. **Voice Cloning Pipeline**: Multi-step onboarding (Platform → Channel → Content → Model → Settings → Test → Verify → Complete)
3. **Real-time Data Flow**: Convex handles persistent data, Redis handles ephemeral sessions
4. **Content Processing**: Automated transcription, voice separation, and audio preparation
5. **RAG Integration**: Embedding-based knowledge retrieval with multiple vector databases

### Frontend Structure
- `/src/app/`: Next.js app router pages including onboarding flows
- `/src/components/custom/`: Application-specific components (analytics, modals, voice interfaces)
- `/src/components/ui/`: Reusable UI components (Radix UI based with Neobrutalist styling)
- `/src/components/onboarding/`: Voice cloning onboarding flow components
- `/src/hooks/`: Custom React hooks for API clients, voice cloning, content fetching
- `/src/lib/`: Utilities, API client, and workflow engine
- `/convex/`: Convex database schema, queries, mutations, and actions

### Backend Structure
- `/src/api/`: FastAPI endpoints and WebSocket handlers
- `/src/services/`: External service clients (Telnyx, Deepgram, content APIs)
- `/src/core/`: Core business logic including orchestrator and lead generation
- `/src/gstreamer/`: Audio processing pipeline
- `/src/chatterbox/`: Open-source TTS integration
- `/src/trelis/`: Additional AI model integrations

## Environment Configuration

Create `.env` files in both frontend and backend directories with required API keys:

```bash
# Backend .env
TELNYX_API_KEY=your_key
DEEPGRAM_API_KEY=your_key
OPENAI_API_KEY=your_key
TTS_PROVIDER=chatterbox  # or elevenlabs
ELEVEN_LABS_API_KEY=your_key
CHATTERBOX_API_URL=http://localhost:5000
REDIS_URL=redis://localhost:6379
JWT_SECRET_KEY=your_secret
API_KEY=your_api_key

# Frontend .env.local (auto-generated by Convex)
NEXT_PUBLIC_API_URL=http://localhost:8000
CONVEX_DEPLOYMENT=your_deployment
NEXT_PUBLIC_CONVEX_URL=your_convex_url
```

## Design System

The application uses a Neobrutalist/Memphis design style characterized by:
- Bold 3px black borders
- Vibrant color palette (pink, yellow, cyan, violet)
- Offset box shadows
- Playful geometric patterns
- Sans-serif typography (system fonts)

See `docs/designdocs/DESIGN_SYSTEM.md` for detailed design specifications and component guidelines.

## Important Considerations

1. **Convex Dependency**: Frontend requires both Convex dev server and Next.js dev server running (`npm run dev:all`)
2. **Voice Cloning Models**: Supports Dia, Orpheus, and Chatterbox TTS models (Kokoro removed due to lack of voice cloning)
3. **Audio Processing**: Uses FFmpeg, Whisper, and audio separation libraries for voice preparation
4. **Content Integration**: Fetches content from YouTube, TikTok, and Twitch for voice training data
5. **Hybrid Data Architecture**: Convex for persistent data, Redis for sessions, FastAPI for real-time processing

## Troubleshooting

### Common Issues
- **"Module not found: Can't resolve '@convex/_generated/api'"**: Ensure Convex dev server is running and restart Next.js
- **"Could not find Convex client!"**: Check ConvexProvider setup and NEXT_PUBLIC_CONVEX_URL in .env.local
- **Voice cloning failures**: Verify audio file format (WAV preferred, 24k sample rate, single speaker, no background noise)

## Documentation

Comprehensive documentation available in `/docs/`:
- `AUDIO_TRANSCRIPTION_API.md`: Audio processing and transcription
- `OUTBOUND_CALLING_SERVICE.md`: Telephony integration
- `AUTOMATION_INTEGRATION.md`: Workflow automation
- `AutoRAG/`: RAG implementation and embeddings
- `Business-Hunter/`: Lead generation system
- `designdocs/DESIGN_SYSTEM.md`: UI component specifications
- `08_chatterbox_integration.md`: TTS provider setup